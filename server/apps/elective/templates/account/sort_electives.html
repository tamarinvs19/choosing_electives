{% extends "base.html" %}
{% load static %}
{% block head_title %}
Выбранные элективы
{% endblock %}
{% block extra_styles %}
  <link rel="stylesheet" type="text/css" href="{% static 'styles/applications.css' %}">
  <script src="https://SortableJS.github.io/Sortable/Sortable.js"></script>
{% endblock %}

{% block body %}
<div class="container">
  <div class="row">
    <h2>Выбранные элективы</h2>
  </div>
  <div class="row canvas">
    <div class="col-md-3 fall-column column">
      <div class="title">
        <h5>Осень</h5>
      </div>
      <div class="inner-column" id="fall">
        {% for application in applications_fall_attached %}
          {% include "account/application_card.html" with application=application %}
        {% endfor %}
      </div>
    </div>
  <div class="col-md-3 main-column" id="mainLeft">
    {% for application in applications_fall %}
      {% include "account/application_card.html" with application=application %}
    {% endfor %}
  </div>
    <div class="col-md-3 main-column" id="mainRight">
      {% for application in applications_spring %}
        {% include "account/application_card.html" with application=application %}
      {% endfor %}
    </div>
  <div class="col-md-3 spring-column column">
    <div class="title">
      <h5>Весна</h5>
    </div>
    <div class="inner-column" id="spring">
      {% for application in applications_spring_attached %}
        {% include "account/application_card.html" with application=application %}
      {% endfor %}
    </div>
  </div>
  </div>
</div>
<script>
  let mainLeftSortable = new Sortable(mainLeft, {
      group: 'electives-fall',
  });
  let fallSortable = new Sortable(fall, {
      group: 'electives-fall',
      onAdd: function (evt) {
          let application = evt.item;
          attachApplication(application);
      }
  });
  let mainRightSortable = new Sortable(mainRight, {
      group: 'electives-spring',
  });
  let springSortable = new Sortable(spring, {
      group: 'electives-spring',
  });

  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');


  function changeExam(applicationId) {
      $.post("{% url 'electives:change_application_exam' %}",
          {'student_on_elective_id': applicationId, 'csrfmiddlewaretoken': csrftoken},
          function(data) {
              if (data['OK'] === true) {
                  $(`#credits-${applicationId}`)[0].innerHTML = data['credit_units'];
              }
              if (data['message']) {
                  // show message
              }
          }
      );
  }

  function changeKind(applicationId, kindId) {
      $.post("{% url 'electives:change_application_kind' %}",
          {'student_on_elective_id': applicationId, 'kind_id': kindId, 'csrfmiddlewaretoken': csrftoken},
          function(data) {
              if (data['OK'] === true) {
                  let examTag = $(`#exam-${applicationId}`)[0];
                  $(`#kind-${applicationId}`)[0].innerHTML = data['full_kind'];
                  $(`#credits-${applicationId}`)[0].innerHTML = data['credit_units'];
                  examTag.innerHTML = data['with_exam'];
                  examTag.disabled = data['is_seminar'] === true;
                  if (data['is_seminar']) {
                      examTag.checked = false;
                  }
              }
              if (data['message']) {
                  // show message
              }
          }
      );
  }

  function attachApplication(application) {
      const applicationId = application.id.split('-')[1];
      $.post("{% url 'electives:attach_application' %}",
          {'student_on_elective_id': applicationId, 'csrfmiddlewaretoken': csrftoken},
          function(data) {}
      );
  }

</script>
{% endblock %}
